name: ğŸ“¦ Package PyPI

on:
  release:
    types: [published]

permissions:
  contents: write
  id-token: write

jobs:
  update-version:
    name: Update Version Files
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ” Determine branch
        id: get_branch
        run: |
          TARGET="${{ github.event.release.target_commitish }}"
          # Remove refs/heads/ or refs/tags/ prefix if present
          BRANCH="${TARGET#refs/heads/}"
          BRANCH="${BRANCH#refs/tags/}"

          # If it's still a tag, try to find the branch
          if git rev-parse --verify "$BRANCH"^{tag} >/dev/null 2>&1; then
            # Find branch containing this tag
            BRANCH=$(git branch -r --contains "$BRANCH" | grep -E "(main|master)" | head -1 | sed 's|origin/||' | xargs || \
                     git branch -r --contains "$BRANCH" | head -1 | sed 's|origin/||' | xargs || \
                     echo "master")
          fi

          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "Using branch: $BRANCH"

      - name: ğŸ”„ Checkout branch
        run: |
          git checkout ${{ steps.get_branch.outputs.branch }} || git checkout -b ${{ steps.get_branch.outputs.branch }}

      - name: ğŸ” Extract version from tag
        id: extract_version
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Tag: ${{ github.event.release.tag_name }}"
          echo "Version: $VERSION"

      - name: ğŸ“ Update LAST_VERSION
        run: |
          echo "${{ steps.extract_version.outputs.version }}" > LAST_VERSION

      - name: ğŸ“ Update pyproject.toml
        run: |
          VERSION="${{ steps.extract_version.outputs.version }}"
          sed -i '/^\[project\]/,/^\[/s/^version = ".*"/version = "'"$VERSION"'"/' pyproject.toml
          sed -i '/^\[tool\.poetry\]/,/^\[/s/^version = ".*"/version = "'"$VERSION"'"/' pyproject.toml

      - name: ğŸ“ Update __init__.py
        run: |
          VERSION="${{ steps.extract_version.outputs.version }}"
          sed -i "s/^__version__ = \".*\"/__version__ = \"$VERSION\"/" mkdocs_simple_blog/__init__.py

      - name: ğŸ’¾ Commit and push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add LAST_VERSION pyproject.toml mkdocs_simple_blog/__init__.py
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ“¦ PyPI: Update version to ${{ steps.extract_version.outputs.version }}"
            git push origin ${{ steps.get_branch.outputs.branch }}
          fi

  test:
    name: Run Tests
    needs: [update-version]
    uses: ./.github/workflows/test.yml
    secrets: inherit

  code-quality:
    name: Code Quality Checks
    needs: [update-version]
    uses: ./.github/workflows/code-quality.yml
    secrets: inherit

  deploy:
    name: Deploy to PyPI
    needs: [update-version, test, code-quality]
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Verify version
        run: |
          echo "Expected: ${{ github.event.release.tag_name }}"
          echo "LAST_VERSION: $(cat LAST_VERSION)"
          echo "pyproject.toml: $(grep '^version = ' pyproject.toml | head -1)"
          echo "__init__.py: $(grep '^__version__ = ' mkdocs_simple_blog/__init__.py)"

      - name: ğŸ“¦ Build Package
        uses: ./.github/actions/build-package
        with:
          python-version: "3.10"

      - name: ğŸ“¦ Publish Package to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
