name: ğŸ“¦ Package PyPI

on:
  release:
    types: [published]

permissions:
  contents: write
  id-token: write

jobs:
  update-version:
    name: Update Version Files
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.event.release.target_commitish }}

      - name: ğŸ” Debug release info
        run: |
          echo "Release tag_name: ${{ github.event.release.tag_name }}"
          echo "Release target_commitish: ${{ github.event.release.target_commitish }}"
          echo "Release published_at: ${{ github.event.release.published_at }}"

      - name: ğŸ” Extract version
        uses: ./.github/actions/extract-version
        id: extract_version
        with:
          tag: ${{ github.event.release.tag_name }}

      - name: ğŸ” Debug extracted version
        run: |
          echo "Extracted version: ${{ steps.extract_version.outputs.version }}"

      - name: ğŸ“ Update version files
        uses: ./.github/actions/update-version
        with:
          version: ${{ steps.extract_version.outputs.version }}

      - name: ğŸ’¾ Commit and push
        uses: ./.github/actions/commit-push
        with:
          message: "ğŸ“¦ PyPI: Update version to ${{ steps.extract_version.outputs.version }}"
          files: "LAST_VERSION pyproject.toml mkdocs_simple_blog/__init__.py"
          branch: ${{ github.event.release.target_commitish }}

  test:
    name: Run Tests
    needs: [update-version]
    uses: ./.github/workflows/test.yml
    secrets: inherit

  code-quality:
    name: Code Quality Checks
    needs: [update-version]
    uses: ./.github/workflows/code-quality.yml
    secrets: inherit

  deploy:
    name: Deploy to PyPI
    needs: [update-version, test, code-quality]
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.target_commitish }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”„ Pull latest changes
        run: |
          git pull origin ${{ github.event.release.target_commitish }} || true

      - name: ğŸ” Verify version
        run: |
          echo "=== Expected version from tag ==="
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"
          echo "Tag version: $VERSION"
          echo ""
          echo "=== LAST_VERSION ==="
          cat LAST_VERSION
          echo ""
          echo "=== pyproject.toml version ==="
          grep "^version = " pyproject.toml | head -2
          echo ""
          echo "=== __init__.py version ==="
          grep "^__version__ = " mkdocs_simple_blog/__init__.py

      - name: ğŸ“¦ Build Package
        uses: ./.github/actions/build-package
        with:
          python-version: "3.10"

      - name: ğŸ“¦ Publish Package to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
